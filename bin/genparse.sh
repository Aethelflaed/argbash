#!/bin/bash

VERSION=0.1

#
#
#
#

# # THE DEFAULTS INITIALIZATION
_ARG_OUTPUT=-



# THE PRINT HELP FUNCION
function print_help
{
	echo "Usage: $0 <input> [--output <arg>] [--version] [--help]"
	echo -e "\t<input>: Positional arg"
	echo -e "\t-o,--output: Name of the output file (pass '-' for stdout) (default: '-')"
	echo -e "\t-v,--version: Prints version"
	echo -e "\t-h,--help: Prints help"
}
# THE PARSING ITSELF
while test $# -gt 0
do
	_key="$1"
	case "$_key" in
		-o|--output)
			_ARG_OUTPUT="$2"
			shift
			;;
		-v|--version)
			echo "[-],[echo "_LIST__ARGS_DEFAULT v$VERSION"],[print_help] v$VERSION"
			exit 0
			;;
		-h|--help)
			print_help
			exit 0
			;;
		*)
		    	POSITIONALS+=("$1")
		    	# unknown option
			;;
	esac
	shift
done

POSITIONAL_NAMES=('_ARG_INPUT' )
test ${#POSITIONALS[@]} -lt 1 && { echo "Not enough positional arguments." &1>2; print_help; exit 1; }
test ${#POSITIONALS[@]} -gt 1 && { echo "There were spurious positional arguments." &1>2; print_help; exit 1; }
for (( ii = 0; ii <  ${#POSITIONALS[@]}; ii++))
do
	eval "${POSITIONAL_NAMES[$ii]}=${POSITIONALS[$ii]}"
done
### END OF CODE GENERATED BY ARGBASH ###


#

# vvv A pretty reliable way of telling where we are
BINDIR="$(cd "$(dirname ${BASH_SOURCE[0]})" && pwd)"
M4DIR="$BINDIR/../src"

function do_stuff
{
	cat $M4DIR/stuff.m4 $M4DIR/output.m4 "$_ARG_INPUT" | autom4te -l m4sugar
}

test -f "$_ARG_INPUT" || { echo "'$_ARG_INPUT' is supposed to be a file!"; exit 1; }
test -n "$_ARG_OUTPUT" || { echo "The output can't be blank - it is not a legal filename!"; exit 1; }
OUTFILE="$_ARG_OUTPUT"

if test "$OUTFILE" = '-'
then
	do_stuff
else
	do_stuff > "$OUTFILE"
	chmod a+x "$OUTFILE"
fi

#
